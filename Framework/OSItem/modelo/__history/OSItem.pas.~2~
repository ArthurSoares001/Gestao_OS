unit OSItem;

interface

uses OrObject, SysUtils, Classes;

type
   TOSItem = class(TOrObject)
      constructor Create;
      destructor Destroy; override;
      private
         id: Integer;
         os: TOrObject;
         produto: TOrObject;
         descricao: string;
         tipo: string;
         qtde: Double;
         precoUnit: Double;
         descontoValor: Double;
         acrescimoValor: Double;
         totalItem: Double;
         observacao: string;
      public
         procedure setId(id: Integer); override;
         procedure setOs(os: TOrObject);
         procedure setProduto(produto: TOrObject);
         procedure setDescricao(descricao: string);
         procedure setTipo(tipo: string);
         procedure setQtde(qtde: Double);
         procedure setPrecoUnit(precoUnit: Double);
         procedure setDescontoValor(descontoValor: Double);
         procedure setAcrescimoValor(acrescimoValor: Double);
         procedure setTotalItem(totalItem: Double);
         procedure setObservacao(observacao: string);

         function getId: Integer; override;
         function getOs: TOrObject;
         function getProduto: TOrObject;
         function getDescricao: string;
         function getTipo: string;
         function getQtde: Double;
         function getPrecoUnit: Double;
         function getDescontoValor: Double;
         function getAcrescimoValor: Double;
         function getTotalItem: Double;
         function getObservacao: string;

         function validar: Boolean; override;
      end;

implementation

uses Constantes, OS, Produto;

constructor TOSItem.Create;
begin
  setId(NULL_INTEGER);
  setOs(TOS.Create);
  setProduto(nil);
  setDescricao('');
  setTipo('');
  setQtde(0);
  setPrecoUnit(0);
  setDescontoValor(0);
  setAcrescimoValor(0);
  setTotalItem(0);
  setObservacao('');
end;

destructor TOSItem.Destroy;
begin
  os.Free;
  if Assigned(produto) then
    produto.Free;
  inherited;
end;

//---------------- gets
function TOSItem.getId: Integer;
begin
  Result := id;
end;

function TOSItem.getOs: TOrObject;
begin
  Result := os;
end;

function TOSItem.getProduto: TOrObject;
begin
  Result := produto;
end;

function TOSItem.getDescricao: string;
begin
  Result := descricao;
end;

function TOSItem.getTipo: string;
begin
  Result := tipo;
end;

function TOSItem.getQtde: Double;
begin
  Result := qtde;
end;

function TOSItem.getPrecoUnit: Double;
begin
  Result := precoUnit;
end;

function TOSItem.getDescontoValor: Double;
begin
  Result := descontoValor;
end;

function TOSItem.getAcrescimoValor: Double;
begin
  Result := acrescimoValor;
end;

function TOSItem.getTotalItem: Double;
begin
  Result := totalItem;
end;

function TOSItem.getObservacao: string;
begin
  Result := observacao;
end;

//---------------- sets
procedure TOSItem.setId(id: Integer);
begin
  inherited;
  self.id := id;
end;

procedure TOSItem.setOs(os: TOrObject);
begin
  self.os := os;
end;

procedure TOSItem.setProduto(produto: TOrObject);
begin
  self.produto := produto;
end;

procedure TOSItem.setDescricao(descricao: string);
begin
  self.descricao := descricao;
end;

procedure TOSItem.setTipo(tipo: string);
begin
  self.tipo := tipo;
end;

procedure TOSItem.setQtde(qtde: Double);
begin
  self.qtde := qtde;
end;

procedure TOSItem.setPrecoUnit(precoUnit: Double);
begin
  self.precoUnit := precoUnit;
end;

procedure TOSItem.setDescontoValor(descontoValor: Double);
begin
  self.descontoValor := descontoValor;
end;

procedure TOSItem.setAcrescimoValor(acrescimoValor: Double);
begin
  self.acrescimoValor := acrescimoValor;
end;

procedure TOSItem.setTotalItem(totalItem: Double);
begin
  self.totalItem := totalItem;
end;

procedure TOSItem.setObservacao(observacao: string);
begin
  self.observacao := observacao;
end;

function TOSItem.validar: Boolean;
begin
  Result := False;

  if not Assigned(getOs) or ((getOs as TOS).getId = NULL_INTEGER) then
    raise Exception.Create('Campo OS é obrigatório!');

  if not Assigned(getProduto) or ((getProduto as TProduto).getId = NULL_INTEGER) then
    raise Exception.Create('Campo Produto é obrigatório!');

  if Trim(getDescricao) = '' then
    raise Exception.Create('Campo Descrição é obrigatório!');

  if Length(Trim(getDescricao)) > 150 then
    raise Exception.Create('Campo Descrição não pode exceder 150 caracteres!');

  if not (getTipo = 'P') and not (getTipo = 'S') then
    raise Exception.Create('Campo Tipo deve ser "P" (Produto) ou "S" (Serviço)!');

  if getQtde <= 0 then
    raise Exception.Create('Campo Quantidade deve ser maior que zero!');

  if getPrecoUnit < 0 then
    raise Exception.Create('Campo Preço Unitário não pode ser negativo!');

  if getDescontoValor < 0 then
    raise Exception.Create('Campo Desconto Valor não pode ser negativo!');

  if getAcrescimoValor < 0 then
    raise Exception.Create('Campo Acréscimo Valor não pode ser negativo!');

  if Length(Trim(getObservacao)) > 150 then
    raise Exception.Create('Campo Observação não pode exceder 150 caracteres!');

  // Verifica consistência do totalItem (conforme fórmula da tabela)
  if Abs(getTotalItem - ((getQtde * getPrecoUnit) - getDescontoValor + getAcrescimoValor)) > 0.01 then
    raise Exception.Create('Campo Total Item deve ser igual a ((Quantidade * Preço Unitário) - Desconto + Acréscimo)!');

  Result := True;
end;

end.
