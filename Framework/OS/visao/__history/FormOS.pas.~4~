unit FormOS;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Constantes, Biblioteca, OS, OrObject,
  Vcl.StdCtrls, Vcl.ComCtrls, Vcl.Mask, RxToolEdit, RxCurrEdit,
  frameformLabel, frameSalvaCancela, Vcl.ExtCtrls, Vcl.Grids, Vcl.Buttons,
  ClienteDB, TecnicoDB, OrList, Cliente, Tecnico;

type
  TFrmOS = class(TForm)
    fraformLabel1: TfraformLabel;
    fraSalvaCancela1: TfraSalvaCancela;
    lblProdutos: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label2: TLabel;
    pnlPesquisar: TPanel;
    BtnPesquisar: TSpeedButton;
    lblFiltro: TLabel;
    Panel1: TPanel;
    SpeedButton1: TSpeedButton;
    pnlValores: TPanel;
    Label4: TLabel;
    Label1: TLabel;
    Label3: TLabel;
    Label7: TLabel;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    lblLogin: TLabel;
    lblObservacao: TLabel;
    Label8: TLabel;
    Label13: TLabel;
    Label14: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    PageControl1: TPageControl;
    TabSheet1: TTabSheet;
    TabSheet2: TTabSheet;
    Label17: TLabel;
    StgServicos: TStringGrid;
    btnAdd: TBitBtn;
    btnRem: TBitBtn;
    Panel2: TPanel;
    SpeedButton2: TSpeedButton;
    TabSheet3: TTabSheet;
    CmbStatus: TComboBox;
    CmbPrioridade: TComboBox;
    CmbCliente: TComboBox;
    CmbTecnico: TComboBox;
    CmbServicos: TComboBox;
    EdtItens: TEdit;
    EdtValorSemDesconto: TEdit;
    EdtDesconto: TEdit;
    EdtValorComDesconto: TEdit;
    EdtQuantidade: TEdit;
    EdtTroco: TEdit;
    Label18: TLabel;
    StgProdutos: TStringGrid;
    BitBtn1: TBitBtn;
    BitBtn2: TBitBtn;
    Panel3: TPanel;
    SpeedButton3: TSpeedButton;
    CmbProdutos: TComboBox;
    lblValorContaPagar: TLabel;
    Label19: TLabel;
    Label20: TLabel;
    StgFormaPagto: TStringGrid;
    btnEdit: TBitBtn;
    CmbFormaPagto: TComboBox;
    EdtValorPagto: TEdit;
    BitBtn3: TBitBtn;
    BitBtn4: TBitBtn;
    EdtDataEntrada: TEdit;
    EdtDataSaida: TEdit;
    EdtNumOS: TEdit;
    EdtTitulo: TEdit;
    EdtDiagnostico: TEdit;
    EdtDataPrevConclusao: TEdit;
    EdtEndereco: TEdit;
    Edit3: TEdit;
    EdtVencimentoPagto: TEdit;
    MemoDescProblema: TMemo;
    MemoSolucaoAplic: TMemo;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure fraSalvaCancela1btnSalvarClick(Sender: TObject);
    procedure fraSalvaCancela1btnCancelarClick(Sender: TObject);
  private
    statusInterface: TStatusInterface;
    os: TOS;
    clienteDB: IClienteDB;
    tecnicoDB: ITecnicoDB;
    procedure setAtributos;
    procedure getAtributos;
    procedure atualizarInterface;
    procedure CarregarCombos;
    procedure PreencherCombo(ACombo: TComboBox; AList: TList; AType: string);
  public
    destructor Destroy; override;
    procedure setStatusInterface(statusInterface: TStatusInterface);
    procedure setOS(os: TOS);
    function getOS: TOS;
  end;

var
  FrmOS: TFrmOS;

implementation

uses
  DataModule, Filtro, ClientePostgreSQL, TecnicoPostgreSQL;

{$R *.dfm}

destructor TFrmOS.Destroy;
begin
  clienteDB := nil;
  tecnicoDB := nil;
  FreeAndNil(os); // Libera a instância de TOS
  inherited Destroy;
end;

procedure TFrmOS.PreencherCombo(ACombo: TComboBox; AList: TList; AType: string);
var
  I: Integer;
  Obj: TOrObject;
  DisplayText: string;
begin
  ACombo.Clear;
  if Assigned(AList) and (AList.Count > 0) then
    for I := 0 to AList.Count - 1 do
    begin
      Obj := TOrObject(AList[I]);
      if AType = 'Cliente' then
        DisplayText := TCliente(Obj).getNomeRazao
      else if AType = 'Tecnico' then
        DisplayText := TTecnico(Obj).getNome
      else
        DisplayText := '';
      ACombo.Items.AddObject(DisplayText, Obj);
    end;
end;

procedure TFrmOS.CarregarCombos;
var
  ListaClientes, ListaTecnicos: TList;
begin
  ListaClientes := clienteDB.ProcurarTodos(TFiltro.Create, 0);
  ListaTecnicos := tecnicoDB.ProcurarTodos(TFiltro.Create, 0);

  try
    PreencherCombo(CmbCliente, ListaClientes, 'Cliente');
    PreencherCombo(CmbTecnico, ListaTecnicos, 'Tecnico');
  finally
    ListaClientes.Free;
    ListaTecnicos.Free;
  end;

  // Preenche combo de origem
  CmbServicos.Items.Clear;
  CmbServicos.Items.Add('Sistema');
  CmbServicos.Items.Add('Telefone');
  CmbServicos.Items.Add('Portal do Cliente');
end;

procedure TFrmOS.atualizarInterface;
begin
  EdtNumOS.MaxLength := 20;
  EdtTitulo.MaxLength := 120;
  EdtDiagnostico.MaxLength := 250;
  EdtEndereco.MaxLength := 250;
  EdtValorPagto.MaxLength := 20;
  EdtQuantidade.MaxLength := 10;
  EdtDesconto.MaxLength := 14;
  EdtTroco.MaxLength := 14;
  MemoDescProblema.MaxLength := 1000;
  MemoSolucaoAplic.MaxLength := 1000;
  organizarTabOrder(Self);
  Position := poScreenCenter;
  KeyPreview := True;
  ShowHint := True;
  BorderStyle := bsNone;

  CarregarCombos;
end;

procedure TFrmOS.FormCreate(Sender: TObject);
begin
  statusInterface := stConsultar;
  os := TOS.Create; // Inicializa TOS para evitar Access Violation
  fraformLabel1.iniciar('Ordem de Serviço - Cadastro', Self);
  fraSalvaCancela1.iniciar(Self);

  // Inicializar interfaces
  clienteDB := TClientePostgreSQL.Create;
  tecnicoDB := TTecnicoPostgreSQL.Create;

  atualizarInterface;
end;

procedure TFrmOS.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_F12 then
    fraSalvaCancela1btnSalvarClick(Self)
  else if Key = VK_ESCAPE then
    if Application.MessageBox(PChar(MSG_SAIR), PChar(MT_CONFIRMACAO), MB_OKCANCEL + MB_ICONQUESTION) = IDOK then
      fraSalvaCancela1.btnCancelarClick(Self);
end;

procedure TFrmOS.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = KEY_ENTER then
  begin
    Key := KEY_TAB;
    Perform(WM_NEXTDLGCTL, 0, 0);
  end;
end;

procedure TFrmOS.FormShow(Sender: TObject);
begin
  limparInterface(Self);
  arredondarInterface(Self);
  if statusInterface in [stConsultar, stAlterar] then
    getAtributos
  else
    EdtDataEntrada.Text := DateToStr(Date);
end;

procedure TFrmOS.fraSalvaCancela1btnSalvarClick(Sender: TObject);
begin
  if Application.MessageBox(PChar(MSG_CONFIRMAR), 'Confirmação', MB_ICONQUESTION + MB_YESNO) = IDYES then
  begin
    setAtributos;
    fraSalvaCancela1.btnSalvarClick(Sender);
  end;
end;

procedure TFrmOS.fraSalvaCancela1btnCancelarClick(Sender: TObject);
begin
  fraSalvaCancela1.btnCancelarClick(Sender);
end;

procedure TFrmOS.getAtributos;
var
  ClienteSel: TCliente;
  TecnicoSel: TTecnico;
begin
  if not Assigned(os) then
    Exit; // Evita Access Violation se os for nil

  with os do
  begin
    EdtNumOS.Text := getNumero;
    ClienteSel := TCliente(getCliente);
    if Assigned(ClienteSel) then
      CmbCliente.ItemIndex := CmbCliente.Items.IndexOf(ClienteSel.getNomeRazao)
    else
      CmbCliente.ItemIndex := -1;
    TecnicoSel := TTecnico(getTecnicoResponsavel);
    if Assigned(TecnicoSel) then
      CmbTecnico.ItemIndex := CmbTecnico.Items.IndexOf(TecnicoSel.getNome)
    else
      CmbTecnico.ItemIndex := -1;
    EdtTitulo.Text := getTitulo;
    MemoDescProblema.Text := getDescricaoProblema;
    EdtDiagnostico.Text := getDiagnostico;
    MemoSolucaoAplic.Text := getSolucaoAplicada;
    CmbServicos.ItemIndex := CmbServicos.Items.IndexOf(getOrigem);
    EdtDataEntrada.Text := DateToStr(getDtAbertura);
    if getDtPrevisaoConclusao <> 0 then
      EdtDataPrevConclusao.Text := DateToStr(getDtPrevisaoConclusao);
    if getDtInicioExecucao <> 0 then
      EdtDataSaida.Text := DateToStr(getDtInicioExecucao);
    if getDtConclusao <> 0 then
      Edit3.Text := DateToStr(getDtConclusao);
    EdtEndereco.Text := getEnderecoExecucao;
    EdtDesconto.Text := FormatFloat('0.00', getValorDesconto);
    EdtTroco.Text := FormatFloat('0.00', getValorAcrescimo);
    EdtValorPagto.Text := getFormaPagamento;
    EdtQuantidade.Text := IntToStr(getAnexosQtde);
  end;
end;

function TFrmOS.getOS: TOS;
begin
  result := os;
end;

procedure TFrmOS.setAtributos;
begin
  if not Assigned(os) then
    os := TOS.Create; // Garante que os esteja inicializado

  with os do
  begin
    setNumero(EdtNumOS.Text);
    if CmbCliente.ItemIndex >= 0 then
      setCliente(TCliente(CmbCliente.Items.Objects[CmbCliente.ItemIndex]))
    else
      setCliente(nil);
    if CmbTecnico.ItemIndex >= 0 then
      setTecnicoResponsavel(TTecnico(CmbTecnico.Items.Objects[CmbTecnico.ItemIndex]))
    else
      setTecnicoResponsavel(nil);
    setTitulo(EdtTitulo.Text);
    setDescricaoProblema(MemoDescProblema.Text);
    setDiagnostico(EdtDiagnostico.Text);
    setSolucaoAplicada(MemoSolucaoAplic.Text);
    setOrigem(CmbServicos.Text);
    setDtAbertura(StrToDateDef(EdtDataEntrada.Text, Date));
    setDtPrevisaoConclusao(StrToDateDef(EdtDataPrevConclusao.Text, 0));
    setDtInicioExecucao(StrToDateDef(EdtDataSaida.Text, 0));
    setDtConclusao(StrToDateDef(Edit3.Text, 0));
    setEnderecoExecucao(EdtEndereco.Text);
    setValorDesconto(StrToFloatDef(EdtDesconto.Text, 0));
    setValorAcrescimo(StrToFloatDef(EdtTroco.Text, 0));
    setFormaPagamento(EdtValorPagto.Text);
    setAnexosQtde(StrToIntDef(EdtQuantidade.Text, 0));
  end;
end;

procedure TFrmOS.setOS(os: TOS);
begin
  if Assigned(Self.os) then
    Self.os.Free;
  Self.os := os;
end;

procedure TFrmOS.setStatusInterface(statusInterface: TStatusInterface);
begin
  Self.statusInterface := statusInterface;
  fraformLabel1.setStatusInterface(statusInterface);
end;

end.
