unit FormProdutoControle;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Grids, Vcl.StdCtrls,
  Vcl.Buttons, Vcl.ExtCtrls, frameRodaPeControle, frameCabecalhoControle,
  frameformLabel, Filtro, Data.DB, Vcl.DBGrids, ProdutoPostgreSQL;

type
  TFrmProdutoControle = class(TForm)
    fraformLabel1: TfraformLabel;
    fraRodaPeControle1: TfraRodaPeControle;
    stgDados: TStringGrid;
    fraCabecalhoControle1: TfraCabecalhoControle;
    procedure FormCreate(Sender: TObject);
    procedure stgDadosDrawCell(Sender: TObject; ACol, ARow: Integer;
      Rect: TRect; State: TGridDrawState);
    procedure FormShow(Sender: TObject);
    procedure fraRodaPeControle1spdEditarClick(Sender: TObject);
    procedure fraRodaPeControle1spdExcluirClick(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure frameCabecalhoControle1spdProcurarClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure fraRodaPeControle1spdImprimirClick(Sender: TObject);
    procedure stgDadosDblClick(Sender: TObject);
    procedure fraRodaPeControle1spdExcelClick(Sender: TObject);
    procedure frameCabecalhoControle1edtDescricaoChange(Sender: TObject);
    procedure fraCabecalhoControle1btnNovoClick(Sender: TObject);
    procedure fraCabecalhoControle1spdProcurarClick(Sender: TObject);
  private
    filtro: TFiltro;
    ProdutoDB: TProdutoPostgreSQL;
    ListaProdutos: TList;
    procedure atualizarGrid;
    procedure atualizarInterface;
    procedure chamarFormProduto;
    procedure FreeListaProdutos;
  public
    constructor Create(AOwner: TComponent); override;
    destructor Destroy; override;
  end;

var
  FrmProdutoControle: TFrmProdutoControle;

implementation

uses
  Constantes, Biblioteca, DataModule, Produto, FormProduto;

{$R *.dfm}

{ TFrmProdutoControle }

constructor TFrmProdutoControle.Create(AOwner: TComponent);
begin
  inherited Create(AOwner);
  ProdutoDB := TProdutoPostgreSQL.Create;
  ListaProdutos := TList.Create;
end;

destructor TFrmProdutoControle.Destroy;
begin
  FreeListaProdutos;
  ListaProdutos.Free;
  ProdutoDB.Free;
  inherited Destroy;
end;

procedure TFrmProdutoControle.FreeListaProdutos;
var
  I: Integer;
begin
  for I := 0 to ListaProdutos.Count - 1 do
    TObject(ListaProdutos[I]).Free;
  ListaProdutos.Clear;
end;

procedure TFrmProdutoControle.atualizarInterface;
begin
  organizarTabOrder(Self);
  Position := poScreenCenter;
  stgDados.Options := stgDados.Options + [goRowSelect];
  stgDados.ScrollBars := ssBoth;
  KeyPreview := True;
  ShowHint := True;
  BorderStyle := bsNone;
  WindowState := wsMaximized;
end;

procedure TFrmProdutoControle.chamarFormProduto;
var
  Produto: TProduto;
begin
  if (stgDados.Row - 1 < 0) or (stgDados.Row - 1 >= ListaProdutos.Count) then
    Exit;

  Produto := TProduto(ListaProdutos[stgDados.Row - 1]);
  frmProduto := TfrmProduto.Create(Self);
  try
    frmProduto.setStatusInterface(stAlterar);
    frmProduto.setProduto(Produto);
    if frmProduto.ShowModal = mrOk then
    begin
      if frmProduto.getProduto.validar then
      begin
        ProdutoDB.Alterar(frmProduto.getProduto);
        atualizarGrid;
      end;
    end;
  finally
    FreeAndNil(frmProduto);
  end;
end;

procedure TFrmProdutoControle.FormCreate(Sender: TObject);
begin
  fraformLabel1.iniciar('Produto - Controle', Self);
  fraCabecalhoControle1.iniciar(Self);
  fraRodaPeControle1.iniciar(NULL_STRING, Self, stgDados);
  filtro := TFiltro.Create;
  atualizarInterface;
end;

procedure TFrmProdutoControle.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_F2 then
    fraCabecalhoControle1btnNovoClick(Self)
  else if Key = VK_F3 then
    frameCabecalhoControle1spdProcurarClick(Self)
  else if Key = VK_ESCAPE then
    Close;
end;

procedure TFrmProdutoControle.FormKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = KEY_ENTER then
  begin
    Key := KEY_TAB;
    Perform(WM_NEXTDLGCTL, 0, 0);
  end;
end;

procedure TFrmProdutoControle.FormShow(Sender: TObject);
begin
  limparInterface(Self);
  atualizarGrid;
end;

procedure TFrmProdutoControle.fraCabecalhoControle1btnNovoClick(Sender: TObject);
var
  Produto: TProduto;
begin
  Produto := TProduto.Create;
  try
    frmProduto := TfrmProduto.Create(Self);
    try
      frmProduto.setStatusInterface(stIncluir);
      frmProduto.setProduto(Produto);
      if frmProduto.ShowModal = mrOk then
      begin
        if frmProduto.getProduto.validar then
        begin
          ProdutoDB.Inserir(frmProduto.getProduto);
          atualizarGrid;
        end;
      end;
    finally
      FreeAndNil(frmProduto);
    end;
  finally
    Produto.Free;
  end;
end;

procedure TFrmProdutoControle.fraCabecalhoControle1spdProcurarClick(
  Sender: TObject);
begin
  filtro.novaInstancia;
  filtro.setDescricao(fraCabecalhoControle1.edtDescricao.Text);
  atualizarGrid;
end;

procedure TFrmProdutoControle.frameCabecalhoControle1edtDescricaoChange(Sender: TObject);
begin
  fraCabecalhoControle1.edtDescricaoChange(Sender);
end;

procedure TFrmProdutoControle.frameCabecalhoControle1spdProcurarClick(Sender: TObject);
begin
  filtro.novaInstancia;
  filtro.setDescricao(fraCabecalhoControle1.edtDescricao.Text);
  atualizarGrid;
end;

procedure TFrmProdutoControle.fraRodaPeControle1spdEditarClick(Sender: TObject);
begin
  chamarFormProduto;
end;

procedure TFrmProdutoControle.fraRodaPeControle1spdExcelClick(Sender: TObject);
begin
  fraRodaPeControle1.spdExcelClick(Sender);
end;

procedure TFrmProdutoControle.fraRodaPeControle1spdExcluirClick(Sender: TObject);
var
  Produto: TProduto;
begin
  if (stgDados.Row - 1 < 0) or (stgDados.Row - 1 >= ListaProdutos.Count) then
    Exit;

  if Application.MessageBox(PChar(MSG_CONFIRMA_EXCLUSAO), 'Confirmação', MB_ICONQUESTION + MB_YESNO) = IDYES then
  begin
    Produto := TProduto(ListaProdutos[stgDados.Row - 1]);
    ProdutoDB.Deletar(Produto);
    atualizarGrid;
  end;
end;

procedure TFrmProdutoControle.fraRodaPeControle1spdImprimirClick(Sender: TObject);
begin
  {
  rptProduto := TrptProduto.Create(Self);
  try
    rptProduto.imprimir(ListaProdutos);
  finally
    FreeAndNil(rptProduto);
  end;
  }
end;

procedure TFrmProdutoControle.stgDadosDblClick(Sender: TObject);
begin
  chamarFormProduto;
end;

procedure TFrmProdutoControle.stgDadosDrawCell(Sender: TObject; ACol, ARow: Integer; Rect: TRect; State: TGridDrawState);
var
  strTemp: string;
  grid: TStringGrid;
begin
  grid := stgDados;
  grid.ColWidths[0] := Trunc(grid.Width * 0.06); // Ativo
  grid.ColWidths[1] := Trunc(grid.Width * 0.08); // Id
  grid.ColWidths[2] := Trunc(grid.Width * 0.30); // Descrição
  grid.ColWidths[3] := Trunc(grid.Width * 0.15); // Preço Padrão
  grid.ColWidths[4] := Trunc(grid.Width * 0.10); // Unidade
  grid.ColWidths[5] := Trunc(grid.Width * 0.10); // Tipo
  grid.ColWidths[6] := Trunc(grid.Width * 0.20); // Código de Barras
  with (Sender as TStringGrid) do
  begin
    strTemp := Cells[ACol, ARow];
    if ACol = ColCount - 1 then
      strTemp := strTemp + StringOfChar(' ', 5);

    Canvas.Font.Style := [];
    Canvas.Font.Color := clBlack;
    Canvas.Brush.Color := clWindow;

    if ARow = 0 then
    begin
      Canvas.Font.Style := [fsBold];
      Canvas.Brush.Color := clBtnFace;
    end
    else
    begin
      if ARow = Row then
      begin
        Canvas.Font.Color := clWhite;
        Canvas.Brush.Color := clHighlight;
      end
      else
      begin
        if ARow mod 2 = 0 then
          Canvas.Brush.Color := clInfoBk
        else
          Canvas.Brush.Color := clWhite;
      end;
      if Cells[0, ARow] = 'N' then
        Canvas.Brush.Color := $007090FF;
    end;
    Canvas.FillRect(Rect);
    if ACol in [2, 6] then
      DrawText(Canvas.Handle, PChar(' ' + strTemp), -1, Rect, DT_SINGLELINE or DT_VCENTER or DT_LEFT)
    else
      DrawText(Canvas.Handle, PChar(' ' + strTemp + ' '), -1, Rect, DT_SINGLELINE or DT_VCENTER or DT_CENTER);
  end;
end;

procedure TFrmProdutoControle.atualizarGrid;
var
  Produto: TProduto;
  I: Integer;
begin
  processando(Self);
  try
    FreeListaProdutos;
    stgDados.RowCount := 2;
    stgDados.Rows[1].Clear;
    stgDados.Cells[0, 0] := 'Ativo';
    stgDados.Cells[1, 0] := 'Id';
    stgDados.Cells[2, 0] := 'Descrição';
    stgDados.Cells[3, 0] := 'Preço';
    stgDados.Cells[4, 0] := 'Unidade';
    stgDados.Cells[5, 0] := 'Tipo';
    stgDados.Cells[6, 0] := 'Código de Barras';

    ListaProdutos := ProdutoDB.ProcurarTodos(filtro, 0);

    if ListaProdutos.Count > 0 then
    begin
      stgDados.RowCount := ListaProdutos.Count + 1;
      for I := 0 to ListaProdutos.Count - 1 do
      begin
        Produto := TProduto(ListaProdutos[I]);
        stgDados.Cells[0, I + 1] := booleanToChar(Produto.getAtivo);
        stgDados.Cells[1, I + 1] := IntToStr(Produto.getId);
        stgDados.Cells[2, I + 1] := Produto.getDescricao;
        stgDados.Cells[3, I + 1] := FormatFloat('0.00', Produto.getPrecoPadrao);
        stgDados.Cells[4, I + 1] := Produto.getUnidade;
        stgDados.Cells[5, I + 1] := Produto.getTipo;
        stgDados.Cells[6, I + 1] := Produto.getCodigoBarras;
      end;
    end;
    fraRodaPeControle1.setRegistro(ListaProdutos.Count);
  finally
    processoFinalizado(Self);
  end;
end;

end.
